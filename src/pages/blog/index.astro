---
import BaseLayout from '../../layouts/BaseLayout.astro';
import BlogPostCard from '../../components/BlogPostCard.astro';
import ThemeToggle from '../../components/ThemeToggle.astro';
import { withBasePath } from '../../lib/base-path';
import { buildBlogIndexSeo } from '../../lib/seo';
import { buildTaxonomyBuckets, getBlogCategoryPath, getBlogTagPath, getPublishedBlogPosts } from '../../lib/blog';

const posts = await getPublishedBlogPosts();
const pageSize = 10;
const visiblePosts = posts.slice(0, pageSize);
const totalPages = Math.max(1, Math.ceil(posts.length / pageSize));
const categories = buildTaxonomyBuckets(posts, 'categories').slice(0, 10);
const tags = buildTaxonomyBuckets(posts, 'tags').slice(0, 16);

const seo = buildBlogIndexSeo({
  site: Astro.site,
  currentUrl: Astro.url,
  basePath: import.meta.env.BASE_URL,
  totalPosts: posts.length,
  totalCategories: categories.length,
  totalTags: tags.length,
  twitterSite: process.env.TWITTER_SITE?.trim(),
  ogLocale: process.env.SEO_OG_LOCALE?.trim() || 'en_US'
});
---

<BaseLayout seo={seo}>
  <main class="mx-auto max-w-6xl space-y-6 px-4 py-8 sm:px-6 lg:px-8">
    <header class="glass-panel p-4 sm:p-5">
      <div class="flex flex-wrap items-center justify-between gap-2">
        <div class="flex items-center gap-2">
          <a class="btn btn-sm btn-ghost" href={withBasePath('/', import.meta.env.BASE_URL)}>Home</a>
          <span class="badge badge-outline">Blog</span>
        </div>
        <div class="flex items-center gap-2">
          <a class="btn btn-sm btn-outline" href={withBasePath('rss.xml', import.meta.env.BASE_URL)}>RSS</a>
          <ThemeToggle location="blog_header" />
        </div>
      </div>
      <h1 class="mt-4 text-3xl font-extrabold sm:text-4xl">HACS Showcase Blog</h1>
      <p class="mt-2 text-sm text-base-content/75">
        Notes, playbooks, and release checklists for reliable Home Assistant integration decisions.
      </p>
    </header>

    <section class="space-y-4">
      <div class="grid gap-4 md:grid-cols-2">
        {visiblePosts.map((post) => <BlogPostCard post={post} basePath={import.meta.env.BASE_URL} />)}
      </div>
      {totalPages > 1 && (
        <div class="flex justify-end">
          <a class="btn btn-primary btn-sm" href={withBasePath('blog/2/', import.meta.env.BASE_URL)}>
            Older posts
          </a>
        </div>
      )}
    </section>

    <section class="grid gap-4 lg:grid-cols-2">
      <article class="section-shell p-4 sm:p-5">
        <h2 class="text-lg font-bold">Categories</h2>
        <div class="mt-3 flex flex-wrap gap-2">
          {categories.map((item) => (
            <a class="badge badge-outline" href={getBlogCategoryPath(item.slug, import.meta.env.BASE_URL)}>
              {item.label} ({item.count})
            </a>
          ))}
        </div>
      </article>

      <article class="section-shell p-4 sm:p-5">
        <h2 class="text-lg font-bold">Tags</h2>
        <div class="mt-3 flex flex-wrap gap-2">
          {tags.map((item) => (
            <a class="badge badge-ghost" href={getBlogTagPath(item.slug, import.meta.env.BASE_URL)}>
              #{item.label}
            </a>
          ))}
        </div>
      </article>
    </section>
  </main>
</BaseLayout>
