---
import BaseLayout from '../../layouts/BaseLayout.astro';
import ThemeToggle from '../../components/ThemeToggle.astro';
import { loadIntegrations } from '../../data/hacs/load';
import {
  freshnessSignal,
  maintenanceSignal,
  popularitySignalsFromStars,
  SCORE_HELP_TEXT,
  SCORE_WEIGHTS
} from '../../lib/score-model';
import { buildIntegrationSeo } from '../../lib/seo';
import { withBasePath } from '../../lib/base-path';

const integrations = await loadIntegrations();

export async function getStaticPaths() {
  const all = await loadIntegrations();
  return all.map((integration) => ({
    params: { slug: integration.slug },
    props: { integration }
  }));
}

const { integration } = Astro.props;

const DAY_MS = 1000 * 60 * 60 * 24;
const nowTs = Date.now();

const updatedLabel = integration.updatedAt
  ? new Date(integration.updatedAt).toLocaleDateString('en-US', {
      year: 'numeric',
      month: 'long',
      day: '2-digit'
    })
  : 'Unknown';

const daysSinceUpdate = integration.updatedTs > 0 ? Math.max(0, Math.floor((nowTs - integration.updatedTs) / DAY_MS)) : null;
const freshnessLabel =
  daysSinceUpdate === null
    ? 'Unknown freshness'
    : daysSinceUpdate <= 14
      ? 'Very fresh'
      : daysSinceUpdate <= 60
        ? 'Fresh'
        : daysSinceUpdate <= 180
          ? 'Moderate freshness'
          : 'Stale signal';

const categoryIntegrations = integrations.filter((item) => item.category === integration.category);
const related = categoryIntegrations.filter((item) => item.slug !== integration.slug).slice(0, 6);
const rankBySlug = new Map(integrations.map((item, index) => [item.slug, index + 1]));

const overallRank = integrations.findIndex((item) => item.slug === integration.slug) + 1;
const categoryRank = categoryIntegrations.findIndex((item) => item.slug === integration.slug) + 1;

const totalCount = integrations.length;
const categoryCount = categoryIntegrations.length;

const scoreValue = Math.min(100, Math.max(0, integration.recommendedScore));
const confidenceValue = Math.min(100, Math.max(0, integration.scoreConfidence ?? integration.recommendedScore));
const scoreBand = scoreValue >= 80 ? 'Top tier' : scoreValue >= 65 ? 'Strong candidate' : scoreValue >= 45 ? 'Needs validation' : 'High risk';

const popularityRanks = popularitySignalsFromStars(integrations.map((item) => item.stars));
const popularitySignal = Math.max(0, popularityRanks[overallRank - 1] ?? 0);
const freshness = freshnessSignal(integration.updatedTs, nowTs);
const maintenance = maintenanceSignal(integration.openIssues, integration.stars);

const popularityContribution = Math.round(popularitySignal * SCORE_WEIGHTS.popularity * 1000) / 10;
const freshnessContribution = Math.round(freshness * SCORE_WEIGHTS.freshness * 1000) / 10;
const maintenanceContribution = Math.round(maintenance * SCORE_WEIGHTS.maintenance * 1000) / 10;

const issueLabel = integration.openIssues <= 10 ? 'Low issue pressure' : integration.openIssues <= 40 ? 'Moderate issue pressure' : 'High issue pressure';
const daysSinceUpdateLabel = daysSinceUpdate === null ? null : `${daysSinceUpdate} day${daysSinceUpdate === 1 ? '' : 's'}`;

const verdictLevel =
  scoreValue >= 80 && confidenceValue >= 65 && freshness >= 0.45 && maintenance >= 0.5
    ? 'go'
    : scoreValue >= 65 && confidenceValue >= 45
      ? 'watch'
      : 'stop';

const verdictLabel = verdictLevel === 'go' ? 'Recommended' : verdictLevel === 'watch' ? 'Validate first' : 'High risk';
const verdictNote =
  verdictLevel === 'go'
    ? 'Good candidate for production adoption with standard monitoring.'
    : verdictLevel === 'watch'
      ? 'Run a staged pilot first and confirm behavior under your real workloads.'
      : 'Adopt only with an explicit fallback plan and risk acceptance.';
const verdictBadgeClass = verdictLevel === 'go' ? 'badge-success' : verdictLevel === 'watch' ? 'badge-warning' : 'badge-error';

const verdictReasons =
  verdictLevel === 'go'
    ? [
        `Score ${scoreValue}/100 with confidence ${confidenceValue}%.`,
        daysSinceUpdateLabel === null
          ? 'Latest update date is unknown and should be manually verified.'
          : `Last repository update was ${daysSinceUpdateLabel} ago.`,
        `${integration.openIssues} open issues for ${integration.stars.toLocaleString('en-US')} stars (${issueLabel.toLowerCase()}).`
      ]
    : verdictLevel === 'watch'
      ? [
          `Score ${scoreValue}/100 (${scoreBand}).`,
          `Confidence is ${confidenceValue}%, so practical validation is still required.`,
          daysSinceUpdateLabel === null
            ? 'Latest update date is unknown, which adds uncertainty to the decision.'
            : `Last repository update was ${daysSinceUpdateLabel} ago (${freshnessLabel.toLowerCase()}).`
        ]
      : [
          `Score ${scoreValue}/100 is below the default adoption comfort zone.`,
          daysSinceUpdateLabel === null
            ? 'Latest update date is unknown and increases operational uncertainty.'
            : `Last repository update was ${daysSinceUpdateLabel} ago (${freshnessLabel.toLowerCase()}).`,
          `${integration.openIssues} open issues indicate ${issueLabel.toLowerCase()}.`
        ];

const popularityBand = popularityContribution >= 35 ? 'Strong' : popularityContribution >= 20 ? 'Moderate' : 'Weak';
const freshnessBand = freshnessContribution >= 20 ? 'Strong' : freshnessContribution >= 10 ? 'Moderate' : 'Weak';
const maintenanceBand = maintenanceContribution >= 13 ? 'Strong' : maintenanceContribution >= 8 ? 'Moderate' : 'Weak';

const popularityPracticalMeaning =
  popularityContribution >= 35
    ? 'Adoption momentum is high, so ecosystem knowledge and peer examples are easier to find.'
    : popularityContribution >= 20
      ? 'Community traction is acceptable, but you should still inspect unresolved issues before rollout.'
      : 'Niche adoption signal: budget more internal validation and support effort.';

const freshnessPracticalMeaning =
  freshnessContribution >= 20
    ? 'Recent development activity lowers stagnation risk and improves compatibility confidence.'
    : freshnessContribution >= 10
      ? 'Activity is present but not fast-moving; watch release cadence after adoption.'
      : 'Stale update signal: verify maintainer responsiveness and changelog quality before trusting it in production.';

const maintenancePracticalMeaning =
  maintenanceContribution >= 13
    ? 'Issue load looks manageable for the current popularity level.'
    : maintenanceContribution >= 8
      ? 'Maintenance pressure is moderate: inspect issue age and severity before adoption.'
      : 'Maintenance pressure is elevated: prioritize fallback and monitoring if you proceed.';

const seo = buildIntegrationSeo({
  site: Astro.site,
  currentUrl: Astro.url,
  basePath: import.meta.env.BASE_URL,
  integration,
  overallRank,
  totalCount,
  categoryRank,
  categoryCount,
  twitterSite: process.env.TWITTER_SITE?.trim(),
  ogLocale: process.env.SEO_OG_LOCALE?.trim() || 'en_US'
});
---

<BaseLayout seo={seo}>
  <main class="mx-auto max-w-6xl space-y-6 px-4 py-8 sm:px-6 lg:px-8">
    <div class="flex flex-wrap items-center justify-between gap-3">
      <a
        href={withBasePath('/', import.meta.env.BASE_URL)}
        class="btn btn-ghost btn-sm gap-1.5"
        data-umami-event="integration_back_to_ranking"
        data-umami-slug={integration.slug}
        data-umami-category={integration.category}
        data-umami-location="integration_header"
      >
        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
          <path stroke-linecap="round" stroke-linejoin="round" d="m15 18-6-6 6-6" />
        </svg>
        Back to ranking
      </a>
      <div class="flex flex-wrap gap-2">
        <a
          class="btn btn-sm btn-ghost"
          href={withBasePath('blog/', import.meta.env.BASE_URL)}
          data-umami-event="integration_open_blog"
          data-umami-slug={integration.slug}
          data-umami-category={integration.category}
          data-umami-location="integration_header"
        >
          Blog
        </a>
        <a
          class="btn btn-sm btn-outline gap-1.5"
          href={`https://github.com/${integration.repo}/issues`}
          target="_blank"
          rel="noopener noreferrer"
          data-umami-event="integration_open_issues"
          data-umami-slug={integration.slug}
          data-umami-category={integration.category}
          data-umami-location="integration_header"
        >
          <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
            <path stroke-linecap="round" stroke-linejoin="round" d="M9 9h6M9 13h4" />
            <path stroke-linecap="round" stroke-linejoin="round" d="M21 12a9 9 0 1 1-3.4-7l.4.3a9 9 0 0 1 3 6.7Z" />
          </svg>
          Issues ({integration.openIssues})
        </a>
        <a
          class="btn btn-sm btn-primary gap-1.5"
          href={integration.url}
          target="_blank"
          rel="noopener noreferrer"
          data-umami-event="integration_open_repository"
          data-umami-slug={integration.slug}
          data-umami-category={integration.category}
          data-umami-location="integration_header"
        >
          <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
            <path stroke-linecap="round" stroke-linejoin="round" d="M14 4h6v6" />
            <path stroke-linecap="round" stroke-linejoin="round" d="M10 14 20 4" />
            <path stroke-linecap="round" stroke-linejoin="round" d="M20 14v4a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h4" />
          </svg>
          Open repository
        </a>
        <ThemeToggle location="integration_header" />
      </div>
    </div>

    <section class="section-shell">
      <div class="flex flex-wrap items-start justify-between gap-3">
        <div>
          <p class="text-[11px] uppercase tracking-[0.16em] text-base-content/60">Quick verdict</p>
          <div class="mt-2 flex flex-wrap items-center gap-2">
            <span class={`badge badge-lg ${verdictBadgeClass}`}>{verdictLabel}</span>
            <span class="text-sm text-base-content/70">Score {scoreValue}/100 | Confidence {confidenceValue}%</span>
          </div>
          <p class="mt-2 max-w-3xl text-sm text-base-content/80">{verdictNote}</p>
        </div>
      </div>
      <div class="mt-4 grid gap-2 sm:grid-cols-3">
        {verdictReasons.map((reason) => (
          <article class="metric-tile p-3">
            <p class="text-sm leading-6 text-base-content/80">{reason}</p>
          </article>
        ))}
      </div>
    </section>

    <section class="aurora-shell">
      <article class="glass-panel p-5 sm:p-7 lg:p-8">
        <div class="grid gap-6 lg:grid-cols-[1.2fr_0.8fr]">
          <div>
            <div class="flex flex-wrap items-center gap-2">
              <span class="badge badge-info badge-outline">{integration.category}</span>
              <span class="badge badge-outline">{integration.domain}</span>
              <span class="badge badge-accent badge-outline">{scoreBand}</span>
              {integration.featured && <span class="badge badge-success badge-outline">Featured profile</span>}
            </div>

            <h1 class="mt-4 text-3xl font-extrabold leading-tight sm:text-4xl lg:text-5xl">{integration.name}</h1>
            <p class="mt-3 text-sm text-base-content/65">{integration.repo}</p>
            <p class="mt-4 max-w-3xl text-base leading-7 text-base-content/85">{integration.description}</p>

            {integration.topics.length > 0 && (
              <div class="mt-5 flex flex-wrap gap-2">
                {integration.topics.map((topic) => <span class="badge badge-outline">#{topic}</span>)}
              </div>
            )}
          </div>

          <aside class="section-shell flex flex-col gap-4 p-4 sm:p-5">
            <p class="text-[11px] uppercase tracking-[0.16em] text-base-content/60">HACS Score cockpit</p>
            <div class="flex items-center justify-between gap-4">
              <div class="radial-progress text-accent" style={`--value:${scoreValue}; --size:7rem; --thickness:0.6rem;`} role="progressbar" aria-valuenow={scoreValue}>
                <span class="text-xl font-extrabold text-base-content">{integration.recommendedScore}</span>
              </div>
              <div class="space-y-2 text-sm">
                <p class="font-semibold text-base-content">{scoreBand}</p>
                <p class="text-base-content/70">#{overallRank} of {totalCount} overall</p>
                <p class="text-base-content/70">#{categoryRank} of {categoryCount} in {integration.category}</p>
              </div>
            </div>

            <div class="grid grid-cols-2 gap-2 text-sm">
              <div class="metric-tile p-3">
                <p class="text-[11px] uppercase tracking-[0.14em] text-base-content/55">Updated</p>
                <p class="mt-1 font-semibold">{updatedLabel}</p>
              </div>
              <div class="metric-tile p-3">
                <p class="text-[11px] uppercase tracking-[0.14em] text-base-content/55">Freshness</p>
                <p class="mt-1 font-semibold">{freshnessLabel}</p>
              </div>
            </div>

            <a
              class="btn btn-primary btn-sm w-full gap-1.5"
              href={integration.url}
              target="_blank"
              rel="noopener noreferrer"
              data-umami-event="integration_evaluate_click"
              data-umami-slug={integration.slug}
              data-umami-category={integration.category}
              data-umami-location="integration_cockpit"
            >
              <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
                <path stroke-linecap="round" stroke-linejoin="round" d="M3 3v18h18" />
                <path stroke-linecap="round" stroke-linejoin="round" d="m19 9-5 5-4-4-4 4" />
              </svg>
              Evaluate this integration
            </a>
          </aside>
        </div>
      </article>
    </section>

    <section class="section-shell">
      <div class="flex flex-wrap items-end justify-between gap-3">
        <div>
          <h2 class="text-2xl font-bold">Decision signals</h2>
          <p class="mt-1 text-sm text-base-content/70">Four checkpoints to validate adoption risk quickly.</p>
        </div>
      </div>

      <div class="mt-4 grid gap-3 sm:grid-cols-2 xl:grid-cols-4">
        <article class="metric-tile">
          <p class="flex items-center gap-1.5 text-[11px] uppercase tracking-[0.15em] text-base-content/55">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-3.5 w-3.5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
              <path stroke-linecap="round" stroke-linejoin="round" d="m12 3 2.8 5.7 6.2.9-4.5 4.4 1.1 6.2L12 17.2 6.4 20.2l1.1-6.2L3 9.6l6.2-.9L12 3Z" />
            </svg>
            Community trust
          </p>
          <p class="mt-1 text-2xl font-extrabold text-success">{integration.stars.toLocaleString('en-US')}</p>
          <p class="mt-1 text-xs text-base-content/70">GitHub stars indicate adoption momentum.</p>
        </article>
        <article class="metric-tile">
          <p class="flex items-center gap-1.5 text-[11px] uppercase tracking-[0.15em] text-base-content/55">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-3.5 w-3.5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
              <path stroke-linecap="round" stroke-linejoin="round" d="M8 9h8M8 13h5" />
              <path stroke-linecap="round" stroke-linejoin="round" d="M21 12a9 9 0 1 1-3.4-7l.4.3a9 9 0 0 1 3 6.7Z" />
            </svg>
            Maintenance pressure
          </p>
          <p class="mt-1 text-2xl font-extrabold">{integration.openIssues}</p>
          <p class="mt-1 text-xs text-base-content/70">{issueLabel}</p>
        </article>
        <article class="metric-tile">
          <p class="flex items-center gap-1.5 text-[11px] uppercase tracking-[0.15em] text-base-content/55">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-3.5 w-3.5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
              <path stroke-linecap="round" stroke-linejoin="round" d="M12 8v4l3 3" />
              <circle cx="12" cy="12" r="9" />
            </svg>
            Update velocity
          </p>
          <p class="mt-1 text-2xl font-extrabold">{daysSinceUpdate === null ? 'n/a' : `${daysSinceUpdate}d`}</p>
          <p class="mt-1 text-xs text-base-content/70">Days from latest repository update.</p>
        </article>
        <article class="metric-tile">
          <p class="flex items-center gap-1.5 text-[11px] uppercase tracking-[0.15em] text-base-content/55">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-3.5 w-3.5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
              <path stroke-linecap="round" stroke-linejoin="round" d="M3 3v18h18" />
              <path stroke-linecap="round" stroke-linejoin="round" d="m19 9-5 5-4-4-4 4" />
            </svg>
            Score confidence
          </p>
          <progress class="progress progress-accent mt-2 w-full" value={confidenceValue} max="100"></progress>
          <p class="mt-2 text-xs text-base-content/70">Confidence from popularity percentile and freshness decay signals.</p>
        </article>
      </div>
    </section>

    <section class="section-shell">
      <div class="flex flex-wrap items-start justify-between gap-3">
        <div>
          <h2 class="text-2xl font-bold">Score breakdown</h2>
          <p class="mt-1 text-sm text-base-content/70">Transparent weighting used to compute HACS Score.</p>
        </div>
        <div class="tooltip tooltip-left max-sm:tooltip-bottom" data-tip={SCORE_HELP_TEXT}>
          <button class="btn btn-ghost btn-xs" type="button" aria-label="How the score is calculated">
            How it is calculated
          </button>
        </div>
      </div>

      <div class="mt-4 grid gap-2 sm:grid-cols-4">
        <article class="rounded-2xl border border-success/35 bg-success/10 p-3 text-xs">
          <p class="font-semibold text-success">80-100</p>
          <p class="mt-1 text-base-content/80">Recommended for production with regular monitoring.</p>
        </article>
        <article class="rounded-2xl border border-info/35 bg-info/10 p-3 text-xs">
          <p class="font-semibold text-info">65-79.9</p>
          <p class="mt-1 text-base-content/80">Strong candidate, but run a short pilot before rollout.</p>
        </article>
        <article class="rounded-2xl border border-warning/35 bg-warning/10 p-3 text-xs">
          <p class="font-semibold text-warning">45-64.9</p>
          <p class="mt-1 text-base-content/80">Needs validation on compatibility and maintenance risk.</p>
        </article>
        <article class="rounded-2xl border border-error/35 bg-error/10 p-3 text-xs">
          <p class="font-semibold text-error">&lt; 45</p>
          <p class="mt-1 text-base-content/80">High risk profile, adopt only with fallback in place.</p>
        </article>
      </div>

      <div class="mt-5 space-y-4">
        <article class="metric-tile">
          <div class="mb-1 flex items-center justify-between gap-3 text-sm">
            <span class="font-medium">Popularity percentile contribution (max 50)</span>
            <div class="flex items-center gap-2">
              <span class="badge badge-success badge-sm">{popularityBand}</span>
              <span class="font-semibold text-success">+{popularityContribution}</span>
            </div>
          </div>
          <progress class="progress progress-success w-full" value={Math.min(50, popularityContribution)} max="50"></progress>
          <div class="mt-2 flex flex-wrap items-center gap-2 text-xs">
            <span class="badge badge-outline">Thresholds: 35-50 strong | 20-34.9 moderate | &lt; 20 weak</span>
            <span class="tooltip max-sm:tooltip-bottom" data-tip="Computed from stars percentile after logarithmic scaling.">
              <button type="button" class="btn btn-ghost btn-xs px-1.5" aria-label="Popularity formula details">
                formula
              </button>
            </span>
          </div>
          <details class="mt-2">
            <summary class="cursor-pointer text-xs font-medium text-base-content/75">Practical meaning</summary>
            <p class="mt-1 text-xs text-base-content/75">{popularityPracticalMeaning}</p>
          </details>
        </article>

        <article class="metric-tile">
          <div class="mb-1 flex items-center justify-between gap-3 text-sm">
            <span class="font-medium">Freshness signal (max 30)</span>
            <div class="flex items-center gap-2">
              <span class="badge badge-info badge-sm">{freshnessBand}</span>
              <span class="font-semibold text-info">+{freshnessContribution}</span>
            </div>
          </div>
          <progress class="progress progress-info w-full" value={Math.min(30, freshnessContribution)} max="30"></progress>
          <div class="mt-2 flex flex-wrap items-center gap-2 text-xs">
            <span class="badge badge-outline">Thresholds: 20-30 strong | 10-19.9 moderate | &lt; 10 weak</span>
            <span class="tooltip max-sm:tooltip-bottom" data-tip="Starts with a 14-day grace period, then decays exponentially over time.">
              <button type="button" class="btn btn-ghost btn-xs px-1.5" aria-label="Freshness formula details">
                formula
              </button>
            </span>
          </div>
          <details class="mt-2">
            <summary class="cursor-pointer text-xs font-medium text-base-content/75">Practical meaning</summary>
            <p class="mt-1 text-xs text-base-content/75">{freshnessPracticalMeaning}</p>
          </details>
        </article>

        <article class="metric-tile">
          <div class="mb-1 flex items-center justify-between gap-3 text-sm">
            <span class="font-medium">Maintenance health contribution (max 20)</span>
            <div class="flex items-center gap-2">
              <span class="badge badge-warning badge-sm">{maintenanceBand}</span>
              <span class="font-semibold text-warning">+{maintenanceContribution}</span>
            </div>
          </div>
          <progress class="progress progress-warning w-full" value={Math.min(20, maintenanceContribution)} max="20"></progress>
          <div class="mt-2 flex flex-wrap items-center gap-2 text-xs">
            <span class="badge badge-outline">Thresholds: 13-20 strong | 8-12.9 moderate | &lt; 8 weak</span>
            <span class="tooltip max-sm:tooltip-bottom" data-tip="Based on open issues normalized by stars and a baseline buffer.">
              <button type="button" class="btn btn-ghost btn-xs px-1.5" aria-label="Maintenance formula details">
                formula
              </button>
            </span>
          </div>
          <details class="mt-2">
            <summary class="cursor-pointer text-xs font-medium text-base-content/75">Practical meaning</summary>
            <p class="mt-1 text-xs text-base-content/75">{maintenancePracticalMeaning}</p>
          </details>
        </article>
      </div>
    </section>

    {related.length > 0 && (
      <section class="section-shell">
        <div class="flex flex-wrap items-end justify-between gap-3">
          <div>
            <h2 class="text-2xl font-bold">Alternatives in {integration.category}</h2>
            <p class="mt-1 text-sm text-base-content/70">Compare nearby candidates ranked by HACS Score.</p>
          </div>
        </div>

        <div class="mt-4 grid gap-3 sm:grid-cols-2 xl:grid-cols-3">
          {related.map((item) => (
            <a
              href={item.detailsPath}
              class="catalog-card-2026 p-4"
              aria-label={`Open ${item.name} details`}
              data-umami-event="integration_related_open"
              data-umami-slug={item.slug}
              data-umami-category={item.category}
              data-umami-location="integration_related"
            >
              <div class="flex items-center justify-between gap-2">
                <h3 class="font-semibold leading-tight">{item.name}</h3>
                <span class="badge badge-outline">#{rankBySlug.get(item.slug)}</span>
              </div>
              <p class="mt-2 text-xs text-base-content/70">{item.repo}</p>
              <div class="mt-3 flex items-center justify-between text-xs">
                <span class="text-success">{item.stars.toLocaleString('en-US')} stars</span>
                <span class="badge badge-accent badge-sm">Score {item.recommendedScore}</span>
              </div>
            </a>
          ))}
        </div>
      </section>
    )}
  </main>
</BaseLayout>
