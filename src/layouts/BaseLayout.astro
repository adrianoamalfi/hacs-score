---
import '../styles/global.css';

const {
  title = 'HACS Showcase',
  description = 'Showcase standout HACS integrations for Home Assistant with featured picks and searchable catalog.'
} = Astro.props;

const canonical = new URL(Astro.url.pathname, Astro.site);
const ogTitle = `${title} | HACS`;
const umamiWebsiteId = process.env.WEBSITE_ID?.trim();
const umamiScriptUrl = process.env.UMAMI_SCRIPT_URL?.trim() || 'https://cloud.umami.is/script.js';
const shouldLoadUmami = import.meta.env.PROD && Boolean(umamiWebsiteId);
---

<!doctype html>
<html lang="en" data-theme="hacs-dark">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="theme-color" content="#102132" />
    <title>{title}</title>

    <meta name="description" content={description} />
    <link rel="canonical" href={canonical} />

    <meta property="og:type" content="website" />
    <meta property="og:title" content={ogTitle} />
    <meta property="og:description" content={description} />
    <meta property="og:url" content={canonical} />
    <meta property="og:site_name" content="HACS Showcase" />

    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:title" content={ogTitle} />
    <meta name="twitter:description" content={description} />

    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link rel="dns-prefetch" href="https://fonts.googleapis.com" />
    <link rel="dns-prefetch" href="https://fonts.gstatic.com" />
    <link
      rel="preload"
      as="style"
      href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;700&family=Syne:wght@600;700;800&display=swap"
      onload="this.onload=null;this.rel='stylesheet'"
    />
    <noscript>
      <link
        href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;700&family=Syne:wght@600;700;800&display=swap"
        rel="stylesheet"
      />
    </noscript>
    {
      shouldLoadUmami && (
        <>
          <script defer src={umamiScriptUrl} data-website-id={umamiWebsiteId}></script>
          <script is:inline>
            (() => {
              const toPayload = (element) => {
                const payload = {};
                const map = {
                  umamiSlug: 'slug',
                  umamiCategory: 'category',
                  umamiLocation: 'location',
                  umamiType: 'type',
                  umamiLabel: 'label',
                  umamiValue: 'value',
                  umamiPreset: 'preset'
                };

                for (const [sourceKey, targetKey] of Object.entries(map)) {
                  const value = element.dataset[sourceKey];
                  if (value) payload[targetKey] = value;
                }

                return payload;
              };

              const track = (eventName, payload = {}) => {
                if (!eventName) return;
                const umami = window.umami;
                if (!umami || typeof umami.track !== 'function') return;
                if (Object.keys(payload).length > 0) {
                  umami.track(eventName, payload);
                  return;
                }
                umami.track(eventName);
              };

              window.__hacsTrack = track;

              document.addEventListener('click', (event) => {
                const target = event.target;
                if (!(target instanceof Element)) return;

                const explicit = target.closest('[data-umami-event]');
                if (explicit instanceof HTMLElement) {
                  const eventName = explicit.dataset.umamiEvent;
                  if (eventName) {
                    track(eventName, toPayload(explicit));
                  }
                }

                const anchor = target.closest('a[href]');
                if (!(anchor instanceof HTMLAnchorElement)) return;

                const href = anchor.getAttribute('href') || '';
                if (!href || href.startsWith('#')) return;

                const destination = new URL(anchor.href, window.location.href);
                if (destination.origin !== window.location.origin) {
                  track('outbound_click', {
                    destination_host: destination.host,
                    destination_path: destination.pathname
                  });
                }
              });
            })();
          </script>
        </>
      )
    }
  </head>
  <body class="min-h-screen">
    <slot />
  </body>
</html>
